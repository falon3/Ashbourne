

<script type="text/javascript" src="/static/admin/js/vendor/jquery/jquery.js"></script>
<script type="text/javascript" src="/static/admin/js/jquery.init.js"></script>
<script type="text/javascript" src="/static/admin/js/admin/RelatedObjectLookups.js"></script>
<script type="text/javascript" src="/static/admin/js/prepopulate.js"></script>


<script>
 
    // draws vector shapes on specified layer. data in wkt string format. example:
    // MULTIPOLYGON (((-12638268.5812490005046129 7081697.4326630001887679, -12637389.5554239992052317 7081582.7771206004545093)))
    function show_vectors(layer, data){ 
        var wkt_f = new OpenLayers.Format.WKT(); 
        //console.log("DATA: ", data)
        
        // iterate through each journey
        data.forEach(function(journey) {
            var pointList = [];
            // add each path for each journey separately
            journey.forEach(function(place) {
                var shape_type = place.feature.substr(0, place.feature.indexOf(" "));
                var geom = wkt_f.read(place.feature);
                if (place.time != null) var time = place.time;
                else var time = ''
                geom.attributes = {
                    'label': '',
                    'color': "orange",
                    'highlight': "0.4",
                    'xOffset': 0,
                    'yOffset': -15,
                    'strokeWidth': 2,
                    'title': place.name,
                    'time': time,
                    'owner': place.person,
                    'category': place.category,
                };
                //console.log(shape_type, geom);
                layer.addFeatures([geom]);
                layer.drawFeature(geom);
                    
                if (shape_type == 'MULTIPOLYGON') pointList = [];
                else if (shape_type == 'POINT'){  
                    
                    var coords = place.feature.replace(/[`~!@#$%^&*()_|+\=?;:'",<>\{\}\[\]\\\/]/gi, '').split(' ');
                    var path_pnt = new OpenLayers.Geometry.Point(coords[1], coords[2]);
                    pointList.push(path_pnt);
                }
                //if at end of points or after two points
                if (pointList.length > 1) { // || i == data.length) {
                    line = new OpenLayers.Geometry.LineString(pointList);
                    var feature = new OpenLayers.Feature.Vector(line);
                    feature.attributes = {
                        'label': '',
                        'dash': "solid",
                        'strokeWidth': 2,
                    };
                    last = pointList[1];
                    pointList = [];
                    pointList.push(last);
                    
                    layer.addFeatures([feature]);
                    layer.drawFeature(feature);
                }
            });
        });
    }
 
 function init(map){
     //var Edmonton_LonLat = [-113.49566,53.52646]; // in EPSG:4326 
     var Edmonton_LonLat = [-12635985, 7079780]; // in EPSG:3857
     
     //base layer
     var OSM_layer = new OpenLayers.Layer.OSM("OpenStreet Map");
     map.addLayer(OSM_layer);

     OpenLayers.Projection.addTransform("EPSG:4326", "EPSG:3857", OpenLayers.Layer.SphericalMercator.projectForward);         
     
     var position       = new OpenLayers.LonLat(Edmonton_LonLat[0],Edmonton_LonLat[1]);
     var zoom           = 16;
     
     // home polygon fences layer  
     var h = new OpenLayers.Style({
         'strokeColor':"${color}",
         'fillColor':"orange", 
         'fillOpacity': 0.4, 
         'label': "${label}",
         'fontColor': "white",
         'fontSize': "12px",
         'fontFamily': "Courier New, monospace",
         'fontWeight': "bold",
         'labelAlign': "cm",
         'labelOutlineColor': "black",
         'labelOutlineWidth': 3,
         'labelXOffset': "${xOffset}",
         'labelYOffset': "${yOffset}"
     });
     var home_style = new OpenLayers.StyleMap(h);
     var other_locs = new OpenLayers.Layer.Vector("Other locations", {
         styleMap: home_style, 
         
     });    
     map.addLayer(other_locs);
     var data = {{known_locations|safe}}; // each location dict including wkt polygon
     show_vectors(other_locs, data);

     // journey from activities layer
     var s = new OpenLayers.Style({
         'strokeColor':"green",
         'pointRadius': 4,
         'strokeWidth': "${strokeWidth}",
         'fillColor':"green", 
         'fillOpacity': "${highlight}", 
         'label': "${label}",
         'fontColor': "white",
         'fontSize': "12px",
         'fontFamily': "Courier New, monospace",
         'fontWeight': "bold",
         'labelAlign': "cm",
         'strokeDashstyle': "${dash}",
         'labelOutlineColor': "black",
         'labelOutlineWidth': 3,
         'labelXOffset': "${xOffset}",
         'labelYOffset': "${yOffset}"
     });
     var path_style = new OpenLayers.StyleMap(s);
     var point_vectors = new OpenLayers.Layer.Vector("Activities path", {styleMap: path_style});
     //console.log(point_vectors);
     map.addLayer(point_vectors);
     var points = {{point_collection|safe}}; // each activity dict including wkt features
     show_vectors(point_vectors, points);
     
     // zoom center and add toggles
     map.addControl(new OpenLayers.Control.LayerSwitcher());
     map.setCenter(position, zoom );  

     selectFeature = new OpenLayers.Control.SelectFeature(
         [other_locs, point_vectors], 
         {
             onSelect: clickNotice,
             click: true,
             autoActivate: true,
             multiple: true
         }
     );
     map.addControl(selectFeature);

     // detect click events onlocations
     function clickNotice(feat) {

         if (feat.layer.name == "Activities path") {
             feat.attributes.highlight = "0.8"; 
             point_vectors.redraw();
             
         }
         else {
             feat.attributes.color = "black"; 
             other_locs.redraw();
         }
         if (feat.geometry.x == null) { // then we have a polygon or linestring
             if (feat.geometry.components.length > 1) return; // skip linestring
             var poplon = feat.geometry.bounds.right - (feat.geometry.bounds.right - feat.geometry.bounds.left)/2;
             var poplat = feat.geometry.bounds.top - (feat.geometry.bounds.top - feat.geometry.bounds.bottom)/2;
             var message = "<center>" + feat.attributes.title + "</center>" + "</br> Person: " + feat.attributes.owner + "</br>Category: " + feat.attributes.category;
         }
         else  { // we have a point    
             var poplon = feat.geometry.x;
             var poplat = feat.geometry.y;
    var message = "<center>" + feat.attributes.time + "</center>";
         }
         
         var popup = new OpenLayers.Popup.FramedCloud(
             "popup", 
             new OpenLayers.LonLat(poplon, poplat),
             new OpenLayers.Size(50,100),
             message,
             null, true, function(){
                 onPopupClose(feat);            
             });  
         console.log(popup);
         popup.maxSize = new OpenLayers.Size(400, 350);
         popup.minSize = new OpenLayers.Size(50, 50);
         feat.popup = popup;
         map.addPopup(popup);
         
     } 
     function onPopupClose(feat) {
         console.log(feat);
         if (feat.layer.name == "Activities path") {
             feat.attributes.highlight = "0.4"; 
             point_vectors.redraw();
         }
         else {
             feat.attributes.color = "orange"; 
             other_locs.redraw();
         }
         map.removePopup(feat.popup);
         feat.popup.destroy();
         
     }
}   

 $(document).ready(function () {
     var options = {
         'target': "map",
         'units' : "m",
         'maxResolution' : 156543.0339,
         'numZoomLevels' : 25,
         'projection' : new OpenLayers.Projection("EPSG:3857"),
         'maxExtent' : new OpenLayers.Bounds(-17037508,40000000,-5000000,12020000)
     };
     var map = new OpenLayers.Map('map', options); 

     init(map);

     // display popup of coords on click (FOR DEVELOPING DEBUGGING)
     /* map.events.register("click", map, function(e) {
        var lonlat = map.getLonLatFromViewPortPx(e.xy);
        var toProjection = new OpenLayers.Projection("EPSG:4326");   // Transform from WGS 1984
        var fromProjection   = new OpenLayers.Projection("EPSG:3857"); // to Spherical Mercator Projection
        var alternate_position       = new OpenLayers.LonLat(lonlat.lon,lonlat.lat).transform( fromProjection, toProjection);

        alert("You clicked near " + lonlat.lon + " E, " +
        + lonlat.lat + " N" + " or: '" + 
        alternate_position.lon + "', '" + alternate_position.lat + "'");      
        });  */
 }); 

</script>  
 
    <span class="mapview">
        <h2 style="text-align:center;" >{{title}}</h2>
        <style type="text/css">
         #map {
             width: 100%;
             height: 80%;
             margin: 10;
         }
        </style>
        <div id="map">
        </div>        
    </span>
    
    <div>
    {% include "filtered_activity_table.html" %}
    </div>
