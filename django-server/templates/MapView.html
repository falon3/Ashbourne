

<script type="text/javascript" src="/static/admin/js/vendor/jquery/jquery.js"></script>
<script type="text/javascript" src="/static/admin/js/jquery.init.js"></script>
<script type="text/javascript" src="/static/admin/js/admin/RelatedObjectLookups.js"></script>
<script type="text/javascript" src="/static/admin/js/prepopulate.js"></script>


<script>
 
    var map; 
    // draws vector shapes on specified layer. data in wkt string format. example:
    // MULTIPOLYGON (((-12638268.5812490005046129 7081697.4326630001887679, -12637389.5554239992052317 7081582.7771206004545093)))
    function show_vectors(layer, data){ 
        var wkt_f = new OpenLayers.Format.WKT(); 
        //var keys = Object.keys(data);
        console.log("DATA: ", data)
        var pointList = [];
        for (var i = 0; i < data.length; i++){
            var shape_type = data[i].feature.substr(0, data[i].feature.indexOf(" "));
            if (shape_type == 'MULTIPOLYGON'){
                var geom = wkt_f.read(data[i].feature);
                label = data[i].name
                if (data[i].time){
                    var time = new Date(data[i].time);
                    time = time.toLocaleDateString() + "\n" + time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    console.log(typeof data[i].time);
                    label = label + "\n\n" + time;
                }
                geom.attributes = {
                    'label': label,
                    'age': 20,
                    'xOffset': 0,
                    'yOffset': -15
                };
                console.log(shape_type, geom);
                layer.addFeatures([geom]);
                layer.drawFeature(geom);
                continue;
            }
            else if (shape_type == 'POINT'){              
                var coords = data[i].feature.replace(/[`~!@#$%^&*()_|+\=?;:'",<>\{\}\[\]\\\/]/gi, '').split(' ');
                var path_pnt = new OpenLayers.Geometry.Point(coords[1], coords[2]);
                console.log("path point: ", path_pnt);
                pointList.push(path_pnt);
            }
            //if at end of points or after two points
            if (pointList.length > 1 || i == data.length) {
                line = new OpenLayers.Geometry.LineString(pointList);
                var feature = new OpenLayers.Feature.Vector(line);
                console.log("FEATURE", feature);
                feature.attributes = {
                    'label': '',
                    'dash': "dot",
                    'strokeWidth': 3,
                };
                last = pointList[1];
                pointList = [];
                pointList.push(last);
                layer.addFeatures([feature]);
                layer.drawFeature(feature);
            }
           
        }
    }
 
    function init(){
        //var Edmonton_LonLat = [-113.49566,53.52646]; // in EPSG:4326 
        var Edmonton_LonLat = [-12636511, 7078908]; // in EPSG:3857
        var options = {
            'units' : "m",
            'maxResolution' : 156543.0339,
            'numZoomLevels' : 20,
            'projection' : new OpenLayers.Projection("EPSG:3857"),
            'maxExtent' : new OpenLayers.Bounds(-17037508,40000000,-5000000,12020000)
        };
        map = new OpenLayers.Map('map', options);
        
        //base layer
        var OSM_layer = new OpenLayers.Layer.OSM("OpenStreet Map");
        map.addLayer(OSM_layer);

        OpenLayers.Projection.addTransform("EPSG:4326", "EPSG:3857", OpenLayers.Layer.SphericalMercator.projectForward);         
        
        var position       = new OpenLayers.LonLat(Edmonton_LonLat[0],Edmonton_LonLat[1]);
        var zoom           = 14;
        
        // home polygon fences layer  
        var h = new OpenLayers.Style({
            'strokeColor':"orange",
            'fillColor':"orange", 
            'fillOpacity': 0.4, 
            'label': "${label}",
            'fontColor': "white",
            'fontSize': "12px",
            'fontFamily': "Courier New, monospace",
            'fontWeight': "bold",
            'labelAlign': "cm",
            'labelOutlineColor': "black",
            'labelOutlineWidth': 3,
            'labelXOffset': "${xOffset}",
            'labelYOffset': "${yOffset}"
        });
        var home_style = new OpenLayers.StyleMap(h);
        var other_locs = new OpenLayers.Layer.Vector("Other locations", {styleMap: home_style});    
        map.addLayer(other_locs);
        var data = {{known_locations|safe}}; // each location dict including wkt polygon
        show_vectors(other_locs, data);

        // journey from activities layer
        var s = new OpenLayers.Style({
            'strokeColor':"green",
            'strokeWidth': "${strokeWidth}",
            'fillColor':"green", 
            'fillOpacity': 0.4, 
            'label': "${label}",
            'fontColor': "white",
            'fontSize': "12px",
            'fontFamily': "Courier New, monospace",
            'fontWeight': "bold",
            'labelAlign': "cm",
            'strokeDashstyle': "${dash}",
            'labelOutlineColor': "black",
            'labelOutlineWidth': 3,
            'labelXOffset': "${xOffset}",
            'labelYOffset': "${yOffset}"
        });
        var path_style = new OpenLayers.StyleMap(s);
        var point_vectors = new OpenLayers.Layer.Vector("Activities path", {styleMap: path_style});
        map.addLayer(point_vectors);
        var points = {{point_collection|safe}}; // each activity dict including wkt point
        show_vectors(point_vectors, points);
        
        // zoom center and add toggles
        map.addControl(new OpenLayers.Control.LayerSwitcher());
        map.setCenter(position, zoom );        
    }

 
 $(document).ready(function () {
     init();

 }); 

</script>  
<link rel="stylesheet" type="text/css" href="/static/admin/css/bootstrap-datetimepicker.css">  
<link rel="stylesheet" type="text/css" href="/static/admin/css/base.css" />    
    <span class="mapview">
        <h2 style="text-align:center;" >{{title}}</h2>
        <style type="text/css">
         #map {
             width: 100%;
             height: 90%;
             margin: 10;
         }
        </style>
        <div id="map">
        </div>        
    </span>
    
    <div>
    {% include "filtered_activity_table.html" %}
    </div>
